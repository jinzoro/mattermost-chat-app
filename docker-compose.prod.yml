version: '3.8'\n\nservices:\n  nginx:\n    image: nginx:alpine\n    container_name: mattermost-nginx\n    restart: unless-stopped\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro\n      - ./nginx/ssl:/etc/nginx/ssl:ro\n      - nginx_logs:/var/log/nginx\n    depends_on:\n      - mattermost\n    networks:\n      - mattermost\n\n  postgres:\n    image: postgres:${POSTGRES_VERSION:-15-alpine}\n    container_name: mattermost-postgres\n    restart: unless-stopped\n    environment:\n      POSTGRES_DB: ${POSTGRES_DB:-mattermost}\n      POSTGRES_USER: ${POSTGRES_USER:-mmuser}\n      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD in .env file}\n      POSTGRES_HOST_AUTH_METHOD: scram-sha-256\n      POSTGRES_INITDB_ARGS: \"--auth-host=scram-sha-256\"\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro\n    networks:\n      - mattermost\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U ${POSTGRES_USER:-mmuser} -d ${POSTGRES_DB:-mattermost}\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n    command: [\n      \"postgres\",\n      \"-c\", \"config_file=/etc/postgresql/postgresql.conf\"\n    ]\n\n  mattermost:\n    image: mattermost/mattermost-team-edition:${MATTERMOST_VERSION:-latest}\n    container_name: mattermost-app\n    restart: unless-stopped\n    depends_on:\n      postgres:\n        condition: service_healthy\n    environment:\n      MM_SQLSETTINGS_DRIVERNAME: postgres\n      MM_SQLSETTINGS_DATASOURCE: \"postgres://${POSTGRES_USER:-mmuser}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-mattermost}?sslmode=require&connect_timeout=10\"\n      MM_SERVICESETTINGS_SITEURL: \"${SITE_URL:?Please set SITE_URL in .env file}\"\n      MM_SERVICESETTINGS_ENABLELOCALMODE: \"false\"\n      MM_SERVICESETTINGS_ENABLEDEVELOPER: \"false\"\n      MM_SERVICESETTINGS_ENABLEINSECUREOUTGOINGCONNECTIONS: \"false\"\n      MM_SERVICESETTINGS_ALLOWCORSFROM: \"${SITE_URL}\"\n      MM_LOGSETTINGS_ENABLECONSOLE: \"false\"\n      MM_LOGSETTINGS_ENABLEFILE: \"true\"\n      MM_FILESETTINGS_MAXFILESIZE: \"52428800\"  # 50MB\n    volumes:\n      - mattermost_config:/mattermost/config\n      - mattermost_data:/mattermost/data\n      - mattermost_logs:/mattermost/logs\n      - mattermost_plugins:/mattermost/plugins\n      - mattermost_client_plugins:/mattermost/client/plugins\n      - mattermost_bleve_indexes:/mattermost/bleve-indexes\n    networks:\n      - mattermost\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8065/api/v4/system/ping\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 90s\n    security_opt:\n      - no-new-privileges:true\n    read_only: false\n    tmpfs:\n      - /tmp\n    user: \"2000:2000\"\n\nvolumes:\n  postgres_data:\n  mattermost_config:\n  mattermost_data:\n  mattermost_logs:\n  mattermost_plugins:\n  mattermost_client_plugins:\n  mattermost_bleve_indexes:\n  nginx_logs:\n\nnetworks:\n  mattermost:\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.20.0.0/16
